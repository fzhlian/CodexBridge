# CodexBridge Implementation Status

## Completed in this repository
- Monorepo scaffold with TypeScript strict mode and ESLint.
- `packages/shared`: protocol types, DSL parser, idempotency abstraction, memory dedupe store, and unit tests.
- `packages/relay-server`: Fastify server, WebSocket machine registry, in-memory rate limiter, `/wecom/callback` endpoint.
- `packages/relay-server`: user allowlist and machine binding checks (env-based).
- `packages/relay-server`: WeCom SHA1 signature verification, AES decrypt helper, callback GET verification route.
- `packages/relay-server`: WeCom XML callback parsing (plain XML + encrypted XML envelope).
- `packages/relay-server`: in-flight command store abstraction and optional result webhook push (`RESULT_WEBHOOK_URL`).
- `packages/relay-server`: WeCom active message push via official API (gettoken + message/send with token cache).
- `packages/relay-server`: encrypted passive XML ack for encrypted callbacks (`Encrypt/MsgSignature/TimeStamp/Nonce`).
- `packages/relay-server`: audit store abstraction (memory/redis index + JSONL append log) and command audit query endpoints.
- `packages/relay-server`: in-flight command cancellation endpoint (`POST /commands/:commandId/cancel`).
- `packages/relay-server`: command retry endpoint (`POST /commands/:commandId/retry`) with new commandId dispatch.
- `packages/relay-server`: machine/inflight ops endpoints (`GET /machines`, `GET /inflight`) backed by memory/redis stores with stale timeout cleanup.
- `packages/relay-server`: machine endpoint includes heartbeat load metrics (`runningCount`, `pendingCount`).
- `packages/relay-server`: audit filtering (`userId/machineId/status`) and retention cap (`AUDIT_MAX_RECORDS`).
- `packages/relay-server`: metrics endpoint (`GET /metrics`) with machine/inflight/audit counters.
- `packages/relay-server`: audit index hydration from JSONL on startup.
- `packages/relay-server`: optional admin-token protection for ops endpoints (`RELAY_ADMIN_TOKEN` + `x-admin-token` header).
- `packages/relay-server`: redacted config snapshot endpoint (`GET /ops/config`).
- `packages/relay-server`: Redis-first store factory (`STORE_MODE`, `AUDIT_INDEX_MODE`) for idempotency, machine state, inflight, and audit index with memory fallback/degraded diagnostics.
- `packages/relay-server`: command template TTL and max-size cleanup for retry storage.
- Added environment template (`.env.example`).
- Added production security checklist (`SECURITY_CHECKLIST.md`).
- `packages/codex-client`: `codex app-server` JSONL RPC client with timeout and restart logic.
- `packages/vscode-agent`: outbound WebSocket agent, heartbeat, `help/status` handlers, diff cache placeholder.
- `packages/vscode-agent`: local confirmation gate, safe unified diff apply, and test runner with allowlist/timeout.
- `packages/vscode-agent`: supports `@dev apply <refId>` and `@dev test [command]`.
- `packages/vscode-agent`: `@dev patch` now requests real patch from codex app-server with bounded context collection.
- `packages/vscode-agent`: supports relay-driven command cancellation (`command.cancel`), including killing running test command.
- `packages/vscode-agent`: VSCode extension entry (`src/extension.ts`) with start/stop/status commands and settings.
- `packages/vscode-agent`: VSCode sidebar chat view (`codexbridge.chatView`) with webview protocol routing.
- `packages/vscode-agent`: chat thread state + workspaceState persistence with configurable message cap.
- `packages/vscode-agent`: chat streaming event channel (`stream_start/chunk/end`) and incremental rendering.
- `packages/vscode-agent`: slash commands (`/plan`, `/patch`, `/test`) in chat panel.
- `packages/vscode-agent`: diff attachment parsing (`DiffFileSummary`) with in-memory `diffId` store.
- `packages/vscode-agent`: virtual diff docs (`codexbridge:` scheme) + `vscode.diff` preview action.
- `packages/vscode-agent`: chat `apply_diff` modal gate + rollback-aware apply safeguards.
- `packages/vscode-agent`: chat `run_test` modal gate + logs attachment response.
- `packages/vscode-agent`: relay command/result callbacks mirrored into local chat thread (`role=remote` + assistant result).
- `packages/vscode-agent`: command queue with configurable concurrency and per-command execution timeout.
- `packages/vscode-agent`: VSCode runtime context adapter (active file/selection/language) wired into patch generation.
- `packages/vscode-agent`: versioned VSIX packaging script and workflow artifacts (`.vsix`, `.sha256`, `release-notes.md`).
- `packages/vscode-agent`: VSCode native modal confirmation for apply/test when running as extension host.
- Added baseline tests in `packages/shared/test`, `packages/relay-server/test`, `packages/vscode-agent/test`.
- Added relay audit store tests (`packages/relay-server/test/audit-store.test.ts`).
- Added machine registry tests (`packages/relay-server/test/machine-registry.test.ts`).
- Added audit filter and pruning tests (`packages/relay-server/test/audit-store.test.ts`).
- Added audit hydration tests (`packages/relay-server/test/audit-store.test.ts`).
- Added GitHub Actions CI workflow (`.github/workflows/ci.yml`) for typecheck/lint/test.
- Added VSCode agent packaging workflow (`.github/workflows/vscode-agent-package.yml`).
- Added VSCode extension release runbook (`docs/RELEASE_VSCODE_AGENT.md`).
- Added local Redis dev compose file (`docker-compose.dev.yml`).
- Added operations runbook (`docs/OPERATIONS.md`).
- Added test deployment guide (`docs/DEPLOY_TEST.md`).
- Added test bootstrap/start scripts (`scripts/bootstrap-test-env.ps1`, `scripts/start-test-stack.ps1`).
- Added relay API reference doc (`docs/API.md`).
- Added demo flow script (`scripts/demo-flow.ps1`) for patch/apply local walkthrough.
- Added relay store factory tests (`packages/relay-server/test/store-factory.test.ts`).
- Added relay store contract/failure-injection coverage for Redis mode fallback diagnostics (`packages/relay-server/test/store-factory.test.ts`).
- Added local Redis dev compose file (`docker-compose.dev.yml`).
- Added operations runbook (`docs/OPERATIONS.md`).

## Not yet completed
- Postgres-backed store option and cross-instance distributed lock strategy.
- End-to-end production hardening for Linux/systemd/Nginx deployment.

## Validation executed
- `pnpm --filter ./packages/vscode-agent typecheck`
- `pnpm --filter ./packages/vscode-agent lint`
- `pnpm --filter ./packages/vscode-agent test`
